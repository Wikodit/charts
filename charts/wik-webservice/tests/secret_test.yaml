suite: secret tests
templates:
  - secret.yaml
tests:
  - it: should create a secret with secret env vars
    set:
      webservice:
        image: nginx:latest
        env:
          secret:
            SECRET_KEY: secret-value
            DB_PASSWORD: db-pass
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: data.SECRET_KEY
          value: c2VjcmV0LXZhbHVl  # base64 encoded
      - equal:
          path: data.DB_PASSWORD
          value: ZGItcGFzcw==  # base64 encoded

  - it: should not create secret when no secret env vars
    set:
      webservice:
        image: nginx:latest
        env:
          plaintext:
            CONFIG: test
    asserts:
      - hasDocuments:
          count: 0

  - it: should use sealedSecrets when enabled
    set:
      general:
        sealedSecrets: true
      webservice:
        image: nginx:latest
        env:
          secret:
            SECRET_KEY: secret-value
    asserts:
      - hasDocuments:
          count: 0  # sealed-secret.yaml should be rendered instead
