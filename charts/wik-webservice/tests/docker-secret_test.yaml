suite: docker secret tests
templates:
  - docker-secret.yaml
  - deployment.yaml
tests:
  - it: should create a docker registry secret when imagePullAuth is provided
    set:
      webservice:
        image: nginx:latest
        imagePullAuth:
          registry: "my-registry.com"
          username: "user"
          password: "pass"
    asserts:
      - containsDocument:
          kind: Secret
          apiVersion: v1
          name: "release-name-wik-webservice-registry"
      - equal:
          path: metadata.name
          value: "release-name-wik-webservice-registry"
      - equal:
          path: type
          value: kubernetes.io/dockerconfigjson
      - exists:
          path: data.".dockerconfigjson"

  - it: should not create docker secret when imagePullAuth is not provided
    set:
      webservice:
        image: nginx:latest
        imagePullAuth: {}
    asserts:
      - notContainsDocument:
          kind: Secret
          apiVersion: v1
      - notContainsDocument:
          kind: SealedSecret
          apiVersion: bitnami.com/v1alpha1

  - it: should include encrypted value when sealedSecrets is enabled
    set:
      general:
        sealedSecrets: true
      webservice:
        image: nginx:latest
        imagePullAuth:
          registry: registry.example.com
          username: myuser
          password: mypass
          encrypted: AgBy3i4OJSWK+PiTySYZZA9rO43cGDEQAx...
    asserts:
      - hasDocuments:
          count: 0  # Should be rendered in sealed-secret.yaml instead
