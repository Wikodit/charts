suite: service tests
templates:
  - service.yaml
tests:
  - it: should create a service when enabled
    set:
      webservice:
        image: nginx:latest
        service:
          enabled: true
          port: 80
    asserts:
      - isKind:
          of: Service
      - equal:
          path: spec.ports[0].port
          value: 80
      - equal:
          path: spec.selector.app.kubernetes.io/name
          value: wik-webservice

  - it: should not create a service when disabled
    set:
      webservice:
        image: nginx:latest
        service:
          enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should include metrics port when enabled
    set:
      webservice:
        image: nginx:latest
        service:
          enabled: true
          port: 80
        metrics:
          enabled: true
          port: 9090
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 80
      - equal:
          path: spec.ports[1].port
          value: 9090
      - equal:
          path: spec.ports[1].name
          value: metrics

  - it: should have service annotations when specified
    set:
      webservice:
        image: nginx:latest
        service:
          enabled: true
          annotations:
            service.beta.kubernetes.io/aws-load-balancer-type: nlb
    asserts:
      - equal:
          path: metadata.annotations."service.beta.kubernetes.io/aws-load-balancer-type"
          value: nlb
