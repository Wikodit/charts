suite: topology spread constraints tests
templates:
  - deployment.yaml
tests:
  - it: should not add topologySpreadConstraints when empty
    set:
      webservice:
        image: nginx:latest
        topologySpreadConstraints: []
    asserts:
      - notExists:
          path: spec.topologySpreadConstraints
  - it: should add topologySpreadConstraints when specified
    set:
      webservice:
        image: nginx:latest
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: kubernetes.io/hostname
            whenUnsatisfiable: DoNotSchedule
            labelSelector:
              matchLabels:
                app.kubernetes.io/name: wik-webservice
                app.kubernetes.io/instance: release-name
    asserts:
      - exists:
          path: spec.topologySpreadConstraints
      - equal:
          path: spec.topologySpreadConstraints[0].maxSkew
          value: 1
      - equal:
          path: spec.topologySpreadConstraints[0].topologyKey
          value: "kubernetes.io/hostname"
      - equal:
          path: spec.topologySpreadConstraints[0].whenUnsatisfiable
          value: "DoNotSchedule"
  - it: should support multiple topologySpreadConstraints
    set:
      webservice:
        image: nginx:latest
        topologySpreadConstraints:
          - maxSkew: 1
            topologyKey: kubernetes.io/hostname
            whenUnsatisfiable: DoNotSchedule
          - maxSkew: 1
            topologyKey: topology.kubernetes.io/zone
            whenUnsatisfiable: ScheduleAnyway
    asserts:
      - equal:
          path: spec.topologySpreadConstraints[0].topologyKey
          value: "kubernetes.io/hostname"
      - equal:
          path: spec.topologySpreadConstraints[1].topologyKey
          value: "topology.kubernetes.io/zone"
